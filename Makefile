MODULES = boot kernel libstd libpatchwork
TARGET_IMAGE = bin/PatchworkOS.img
VERSION_HEADER = include/common/version.h

PROGRAMS = $(basename $(notdir $(wildcard make/programs/*.mk)))

ROOT_PROGRAMS = init wall cursor taskbar startmenu dwm shell delete dir link move open read write
USER_PROGRAMS = $(filter-out $(ROOT_PROGRAMS),$(PROGRAMS))

QEMU_MEMORY ?= 1G
QEMU_CPUS ?= $(shell nproc 2>/dev/null || echo 8)
QEMU_MACHINE ?= q35
QEMU_ARGS ?=

QEMU_FLAGS = \
	-M $(QEMU_MACHINE) \
	-display sdl \
	-serial stdio \
	-drive format=raw,file=$(TARGET_IMAGE) \
	-m $(QEMU_MEMORY) \
	-smp $(QEMU_CPUS) \
	-cpu qemu64 \
	-drive if=pflash,format=raw,unit=0,file=lib/OVMFbin/OVMF_CODE-pure-efi.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=lib/OVMFbin/OVMF_VARS-pure-efi.fd

ifeq ($(DEBUG),1)
	ifneq ($(GDB),1)
		QEMU_FLAGS += -device isa-debug-exit
	endif
else
	QEMU_FLAGS += -no-shutdown -no-reboot
endif

ifeq ($(GDB),1)
	QEMU_FLAGS += -s -S
endif

.PHONY: all setup modules programs deploy run clean generate_version compile_commands format doxygen clean clean_programs nuke

all: setup modules programs deploy

generate_version:
	@GIT_VERSION_STRING=$$(git describe --tags --always --dirty --long 2>/dev/null || echo "unknown"); \
	echo "#pragma once" > $(VERSION_HEADER); \
	echo "" >> $(VERSION_HEADER); \
	echo "/**" >> $(VERSION_HEADER); \
	echo " * @file version.h" >> $(VERSION_HEADER); \
	echo " * @brief Generated by Makefile from Git information." >> $(VERSION_HEADER); \
	echo " */" >> $(VERSION_HEADER); \
	echo "" >> $(VERSION_HEADER); \
	echo "#define OS_NAME \"PatchworkOS\"" >> $(VERSION_HEADER); \
	echo "#define OS_VERSION \"$$GIT_VERSION_STRING\"" >> $(VERSION_HEADER); \
	echo "" >> $(VERSION_HEADER)

setup: generate_version
	$(MAKE) -C lib/gnu-efi

$(MODULES): setup
	$(MAKE) -f make/$@.mk SRCDIR=src/$@ BUILDDIR=build/$@ BINDIR=bin/$@

$(PROGRAMS): $(MODULES)
	$(MAKE) -f make/programs/$@.mk SRCDIR=src/programs/$@ BUILDDIR=build/programs/$@ BINDIR=bin/programs PROGRAM=$@

deploy: $(PROGRAMS)
	dd if=/dev/zero of=$(TARGET_IMAGE) bs=2M count=64
	mformat -F -C -t 256 -h 16 -s 63 -v "PATCHWORKOS" -i $(TARGET_IMAGE) ::
	mlabel -i $(TARGET_IMAGE) ::PatchworkOS
	mmd -i $(TARGET_IMAGE) ::/boot
	mmd -i $(TARGET_IMAGE) ::/bin
	mmd -i $(TARGET_IMAGE) ::/efi
	mmd -i $(TARGET_IMAGE) ::/efi/boot
	mmd -i $(TARGET_IMAGE) ::/usr
	mmd -i $(TARGET_IMAGE) ::/usr/bin
	mmd -i $(TARGET_IMAGE) ::/usr/license
	mmd -i $(TARGET_IMAGE) ::/home
	mmd -i $(TARGET_IMAGE) ::/dev
	mmd -i $(TARGET_IMAGE) ::/net
	mmd -i $(TARGET_IMAGE) ::/proc
	mcopy -i $(TARGET_IMAGE) -s root/* ::
	mcopy -i $(TARGET_IMAGE) -s bin/boot/bootx64.efi ::/efi/boot
	mcopy -i $(TARGET_IMAGE) -s bin/kernel/kernel ::/boot
	mcopy -i $(TARGET_IMAGE) -s LICENSE ::/usr/license
	$(foreach prog,$(ROOT_PROGRAMS),mcopy -i $(TARGET_IMAGE) -s bin/programs/$(prog) ::/bin;)
	$(foreach prog,$(USER_PROGRAMS),mcopy -i $(TARGET_IMAGE) -s bin/programs/$(prog) ::/usr/bin;)
	
run: all
	qemu-system-x86_64 $(QEMU_FLAGS) $(QEMU_ARGS)

# This will only work if you have setup a grub loopback entry as described in the README.md file.
grub_loopback:
	cp $(TARGET_IMAGE) /data/PatchworkOS.img

compile_commands: clean
	bear -- $(MAKE) all

format:
	find src/ include/ meta/doxy tools/ -iname '*.h' -o -iname '*.c' -o -iname '*.dox' | xargs clang-format -style=file -i

doxygen:
	if [ ! -d "meta/docs/doxygen-awesome-css" ]; then \
	    git clone https://github.com/jothepro/doxygen-awesome-css.git meta/docs/doxygen-awesome-css; \
		cd meta/docs/doxy/doxygen-awesome-css; \
		git checkout v2.3.4; \
		cd ../../../..; \
	fi
	doxygen meta/doxy/Doxyfile

clean:
	rm -rf build
	rm -rf bin
	rm -rf $(VERSION_HEADER)

clean_programs:
	rm -rf build/programs
	rm -rf bin/programs

nuke: clean
	$(MAKE) -C lib/gnu-efi clean
	rm -rf lib/doomgeneric-patchworkos
	rm -rf lib/lua-5.4.7